name: Generate Fresh Snapshots

on:
  workflow_dispatch:
    inputs:
      ref:
        description: 'Branch or commit to run against'
        required: false
        default: 'main'
        type: string

jobs:
  check-prerequisites:
    runs-on: ubuntu-24.04
    outputs:
      workflow-run-id: ${{ steps.get-workflow.outputs.workflow-run-id }}
      workflow-status: ${{ steps.get-workflow.outputs.workflow-status }}
    steps:
      - name: Get latest workflow run
        id: get-workflow
        uses: actions/github-script@v7
        with:
          script: |
            const { data: runs } = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'build-and-test.yaml',
              branch: '${{ inputs.ref || github.ref_name }}',
              per_page: 1,
              status: 'completed'
            });

            if (runs.total_count === 0) {
              core.setFailed('No completed workflow runs found for the specified branch');
              return;
            }

            const latestRun = runs.workflow_runs[0];
            core.setOutput('workflow-run-id', latestRun.id);
            core.setOutput('workflow-status', latestRun.conclusion);

            if (latestRun.conclusion !== 'success') {
              core.setFailed(`Latest workflow run (${latestRun.id}) did not complete successfully. Status: ${latestRun.conclusion}`);
            }

  generate-snapshots:
    runs-on: ubuntu-24.04
    container: mcr.microsoft.com/playwright:v1.54.2-noble
    needs: check-prerequisites
    env:
      # See: https://github.com/microsoft/playwright/issues/27620
      HOME: /root
    steps:
      # As we are in another container, we need to install LFS manually.
      # See: https://github.com/orgs/community/discussions/160433
      - name: Install LFS
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          curl -s https://packagecloud.io/install/repositories/github/git-lfs/script.deb.sh | bash
          apt install git-lfs -y

      - name: Configure Git
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - uses: actions/checkout@v5
        with:
          ref: ${{ inputs.ref || github.ref }}
          lfs: true
          fetch-depth: 0

      - name: Verify repository contents
        run: |
          echo "=== Repository Structure Debug ==="
          echo "Current working directory:"
          pwd
          echo "Root directory contents:"
          ls -la
          echo "Checking for playwright directory:"
          ls -la playwright/ || echo "playwright directory not found"
          echo "Checking for playwright/e2e directory:"
          ls -la playwright/e2e/ || echo "playwright/e2e directory not found"
          echo "Checking git status:"
          git status || echo "Git status failed"
          echo "Checking LFS status:"
          git lfs status || echo "Git LFS status failed"

          # Try to manually pull LFS files if they're missing
          if [ ! -d "playwright/e2e" ]; then
            echo "=== Attempting to manually pull LFS files ==="
            git lfs pull || echo "LFS pull failed"
            echo "Checking again after LFS pull:"
            ls -la playwright/ || echo "playwright directory still not found"
            ls -la playwright/e2e/ || echo "playwright/e2e directory still not found"
          fi

      - uses: actions/setup-node@v4
        with:
          node-version: lts/jod
          cache: 'npm'

      # Download the dist artifacts from the latest successful build-and-test workflow
      - name: Download build artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Get artifacts from the successful workflow run
            const { data: artifacts } = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: ${{ needs.check-prerequisites.outputs.workflow-run-id }}
            });

            const distArtifact = artifacts.artifacts.find(artifact => artifact.name === 'dist');
            if (!distArtifact) {
              core.setFailed('No dist artifact found in the latest workflow run');
              return;
            }

            // Download the artifact
            const download = await github.rest.actions.downloadArtifact({
              owner: context.repo.owner,
              repo: context.repo.repo,
              artifact_id: distArtifact.id,
              archive_format: 'zip',
            });

            fs.writeFileSync('dist.zip', Buffer.from(download.data));

      - name: Install unzip utility
        run: apt-get update && apt-get install -y unzip

      - name: Extract build artifacts
        run: |
          unzip -q dist.zip
          echo "Contents after extraction:"
          ls -la

          # Check if dist directory exists, if not, the contents might be extracted directly
          if [ ! -d "dist" ]; then
            echo "No dist directory found, checking if contents were extracted directly..."
            # Look for element-examples and dashboards-demo directories
            if [ -d "element-examples" ] || [ -d "dashboards-demo" ]; then
              echo "Found dist contents directly, creating dist directory structure..."
              mkdir -p dist
              [ -d "element-examples" ] && mv element-examples dist/
              [ -d "dashboards-demo" ] && mv dashboards-demo dist/
              # Move any other potential dist contents
              for dir in */; do
                if [ "$dir" != "dist/" ] && [ "$dir" != "node_modules/" ] && [ "$dir" != ".git/" ]; then
                  echo "Moving $dir to dist/"
                  mv "$dir" dist/ 2>/dev/null || true
                fi
              done
            else
              echo "ERROR: Neither dist directory nor expected contents found"
              echo "Available directories:"
              ls -la
              exit 1
            fi
          fi

          echo "Final dist directory structure:"
          ls -la dist/
          echo "Checking for required directories:"
          ls -la dist/element-examples/ || echo "element-examples not found"
          ls -la dist/dashboards-demo/ || echo "dashboards-demo not found"

          # Check if playwright directory is in dist and copy it to root if needed
          if [ -d "dist/playwright" ]; then
            echo "Found playwright directory in dist, copying to root..."
            cp -r dist/playwright ./
            echo "Playwright directory copied successfully"
            ls -la playwright/
          fi

      # Not injecting the token will exclude the brand packages, but this is fine for e2e tests.
      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit --include=optional

      # Fix Docker config permission issue
      - name: Fix Docker permissions
        run: |
          mkdir -p /root/.docker
          chmod 755 /root/.docker
          # Create a minimal Docker config to avoid permission errors
          echo '{}' > /root/.docker/config.json
          chmod 644 /root/.docker/config.json

      # Install http-server globally to ensure it's available
      - name: Install http-server
        run: npm install -g http-server

      # Test if the web servers can start properly
      - name: Test web server startup
        run: |
          echo "Testing element-examples server..."
          if [ -d "dist/element-examples" ]; then
            timeout 10s npx http-server dist/element-examples -s -p 4200 -a 127.0.0.1 &
            SERVER_PID=$!
            sleep 5
            if curl -f http://127.0.0.1:4200/ > /dev/null 2>&1; then
              echo "element-examples server started successfully"
            else
              echo "element-examples server failed to start or respond"
            fi
            kill $SERVER_PID || true
          else
            echo "dist/element-examples directory not found"
            exit 1
          fi

          echo "Testing dashboards-demo server..."
          if [ -d "dist/dashboards-demo" ]; then
            timeout 10s npx http-server dist/dashboards-demo -s -p 4201 -a 127.0.0.1 &
            SERVER_PID=$!
            sleep 5
            if curl -f http://127.0.0.1:4201/ > /dev/null 2>&1; then
              echo "dashboards-demo server started successfully"
            else
              echo "dashboards-demo server failed to start or respond"
            fi
            kill $SERVER_PID || true
          else
            echo "dist/dashboards-demo directory not found"
            exit 1
          fi

      - name: Generate fresh snapshots
        run: |
          echo "=== Final Pre-flight Check ==="
          echo "Current working directory:"
          pwd
          echo "Repository contents:"
          ls -la

          echo "=== Checking Playwright Setup ==="
          echo "Playwright config file exists:"
          ls -la playwright.config.ts || echo "playwright.config.ts not found"
          echo "Playwright directory contents:"
          ls -la playwright/ || echo "playwright directory not found"
          echo "Test directories:"
          ls -la playwright/e2e/ || echo "playwright/e2e directory not found"

          # If playwright directory is still missing, try to copy from dist
          if [ ! -d "playwright/e2e" ] && [ -d "dist/playwright/e2e" ]; then
            echo "=== Copying playwright directory from dist ==="
            cp -r dist/playwright ./
            echo "Playwright directory copied from dist"
            ls -la playwright/
            ls -la playwright/e2e/
          fi

          if [ ! -d "playwright/e2e" ]; then
            echo "ERROR: playwright/e2e directory is still missing!"
            echo "This suggests the repository was not properly checked out."
            echo "Available playwright-related directories:"
            find . -type d -name "*playwright*" -o -name "*e2e*" || echo "No playwright or e2e directories found"
            exit 1
          fi

          echo "Environment variables:"
          echo "PLAYWRIGHT_CONTAINER=$PLAYWRIGHT_CONTAINER"
          echo "PLAYWRIGHT_isvrt=$PLAYWRIGHT_isvrt"
          echo "PLAYWRIGHT_isa11y=$PLAYWRIGHT_isa11y"
          echo "CI=$CI"

          echo "=== Running Playwright list to see available tests ==="
          npx playwright test --list || echo "Failed to list tests"

          echo "=== Running Playwright with snapshots update ==="
          npx playwright test --update-snapshots=all --reporter=line
        env:
          PLAYWRIGHT_CONTAINER: true
          PLAYWRIGHT_isvrt: 'true'
          PLAYWRIGHT_isa11y: 'false'
          # Increase web server timeout for container environment
          PLAYWRIGHT_WEB_SERVER_TIMEOUT: 120000

      - name: Create snapshots archive
        run: |
          # Create a timestamped archive of the updated snapshots
          TIMESTAMP=$(date +"%Y%m%d-%H%M%S")
          BRANCH_NAME="${{ inputs.ref || github.ref_name }}"
          ARCHIVE_NAME="playwright-snapshots-${BRANCH_NAME}-${TIMESTAMP}"

          # Create archive directory structure
          mkdir -p "${ARCHIVE_NAME}"
          cp -r playwright/snapshots "${ARCHIVE_NAME}/"

          # Add metadata file
          cat > "${ARCHIVE_NAME}/snapshot-info.txt" << EOF
          Generated on: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Branch/Ref: ${BRANCH_NAME}
          Commit SHA: ${{ github.sha }}
          Workflow Run: ${{ github.run_id }}
          Generated from workflow run: ${{ needs.check-prerequisites.outputs.workflow-run-id }}
          EOF

          # Create tar.gz archive
          tar -czf "${ARCHIVE_NAME}.tar.gz" "${ARCHIVE_NAME}"

          echo "ARCHIVE_NAME=${ARCHIVE_NAME}" >> $GITHUB_ENV

      - name: Upload fresh snapshots
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARCHIVE_NAME }}
          path: ${{ env.ARCHIVE_NAME }}.tar.gz
          retention-days: 30

      - name: Generate test report
        if: always()
        run: npx playwright show-report --reporter=html || true

      - name: Upload test report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-snapshots-${{ inputs.ref || github.ref_name }}-${{ github.run_id }}
          path: playwright-report
          retention-days: 7

  summary:
    runs-on: ubuntu-24.04
    needs: [check-prerequisites, generate-snapshots]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## Snapshot Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch/Ref:** ${{ inputs.ref || github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Based on workflow run:** ${{ needs.check-prerequisites.outputs.workflow-run-id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ needs.generate-snapshots.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.generate-snapshots.result }}" = "success" ]; then
            echo "✅ Fresh snapshots have been generated successfully!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The updated snapshots are available as downloadable artifacts from this workflow run." >> $GITHUB_STEP_SUMMARY
            echo "Look for the artifact named \`playwright-snapshots-*\` in the artifacts section." >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Snapshot generation failed. Check the logs for details." >> $GITHUB_STEP_SUMMARY
          fi
